{% extends "photometadata/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö {% if filename %} ({{ filename }}){% endif %}</h2>
    <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> {% if source_type == 'db' %}–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö{% else %}JSON —Ñ–∞–π–ª{% endif %}</p>

    {% if source_type == 'db' %}
      <div class="mb-3">
        <input type="text" id="search-input" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...">
      </div>
    {% endif %}

    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–§–æ—Ç–æ–≥—Ä–∞—Ñ</th>
          <th>–î–∞—Ç–∞</th>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>
          <th>–ö–∞–º–µ—Ä–∞</th>
          <th>–õ–∏—Ü–µ–Ω–∑–∏—è</th>
          <th>–®–∏—Ä–∏–Ω–∞</th>
          <th>–í—ã—Å–æ—Ç–∞</th>
          <th>–¢–µ–≥–∏</th>
          <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
          {% if source_type == 'db' %}<th>–î–µ–π—Å—Ç–≤–∏—è</th>{% endif %}
        </tr>
      </thead>
      <tbody id="data-body">
        {% for item in data %}
          <tr data-id="{{ item.id|default:'' }}">
            <td>{{ item.title }}</td>
            <td>{{ item.photographer }}</td>
            <td>{{ item.date_taken }}</td>
            <td>{{ item.description }}</td>
            <td>{{ item.location }}</td>
            <td>{{ item.camera }}</td>
            <td>{{ item.license }}</td>
            <td>{{ item.width }}</td>
            <td>{{ item.height }}</td>
            <td>{{ item.tags }}</td>
            <td>
              {% if item.url %}
                <a href="{{ item.url }}" target="_blank">
                  <img src="{{ item.url }}" alt="{{ item.title }}" style="max-width:100px; border-radius:6px;">
                </a>
              {% else %}‚Äî{% endif %}
            </td>
            {% if source_type == 'db' %}
            <td>
              <button class="btn btn-sm btn-warning edit-btn" data-id="{{ item.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="{{ item.id }}">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <a href="{% url 'photometadata:json_list' %}" class="btn btn-secondary mt-3">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤</a>
</div>

{% if source_type == 'db' %}
<!-- ======= –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ======= -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="edit-id">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" id="edit-title" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ</label>
              <input type="text" id="edit-photographer" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">–î–∞—Ç–∞</label>
              <input type="date" id="edit-date" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
              <input type="text" id="edit-location" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">–ö–∞–º–µ—Ä–∞</label>
              <input type="text" id="edit-camera" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">–õ–∏—Ü–µ–Ω–∑–∏—è</label>
              <input type="text" id="edit-license" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">–®–∏—Ä–∏–Ω–∞</label>
              <input type="number" id="edit-width" class="form-control" required min="1">
            </div>
            <div class="col-md-6">
              <label class="form-label">–í—ã—Å–æ—Ç–∞</label>
              <input type="number" id="edit-height" class="form-control" required min="1">
            </div>
            <div class="col-12">
              <label class="form-label">–¢–µ–≥–∏</label>
              <input type="text" id="edit-tags" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–∏—Ä–æ–¥–∞, –≥–æ—Ä–æ–¥" required>
            </div>
            <div class="col-12">
              <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea id="edit-description" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
              <input type="text" id="edit-url" class="form-control">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveEditBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
const csrftoken = '{{ csrf_token }}';

// ======= –ü–û–ò–°–ö =======
document.getElementById('search-input').addEventListener('input', function() {
    const q = this.value.trim();
    const url = "{% url 'photometadata:db_search_ajax' %}";
    const body = document.getElementById('data-body');

    // üîπ –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
    if (q === "") {
        fetch("{% url 'photometadata:db_view_ajax' %}") // —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint –¥–ª—è "–≤—Å–µ –¥–∞–Ω–Ω—ã–µ"
        .then(r => r.json())
        .then(data => {
            body.innerHTML = "";
            for (const item of data.results) {
                const row = `
                    <tr data-id="${item.id}">
                        <td>${item.title}</td>
                        <td>${item.photographer}</td>
                        <td>${item.date_taken}</td>
                        <td>${item.description}</td>
                        <td>${item.location}</td>
                        <td>${item.camera}</td>
                        <td>${item.license}</td>
                        <td>${item.width}</td>
                        <td>${item.height}</td>
                        <td>${item.tags}</td>
                        <td><a href="${item.url}" target="_blank"><img src="${item.url}" style="max-width:100px;border-radius:6px;"></a></td>
                        <td>
                            <button class="btn btn-sm btn-warning edit-btn" data-id="${item.id}">–†–µ–¥.</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}">–£–¥–∞–ª.</button>
                        </td>
                    </tr>`;
                body.insertAdjacentHTML('beforeend', row);
            }
        });
        return;
    }

    // üîπ –ò–Ω–∞—á–µ ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫
    fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
        body: JSON.stringify({ q })
    })
    .then(r => r.json())
    .then(data => {
        body.innerHTML = "";
        for (const item of data.results) {
            const row = `
                <tr data-id="${item.id}">
                    <td>${item.title}</td>
                    <td>${item.photographer}</td>
                    <td>${item.date_taken}</td>
                    <td>${item.description}</td>
                    <td>${item.location}</td>
                    <td>${item.camera}</td>
                    <td>${item.license}</td>
                    <td>${item.width}</td>
                    <td>${item.height}</td>
                    <td>${item.tags}</td>
                    <td><a href="${item.url}" target="_blank"><img src="${item.url}" style="max-width:100px;border-radius:6px;"></a></td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${item.id}">–†–µ–¥.</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}">–£–¥–∞–ª.</button>
                    </td>
                </tr>`;
            body.insertAdjacentHTML('beforeend', row);
        }
    });
});

// ======= AJAX –£–î–ê–õ–ï–ù–ò–ï =======
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('delete-btn')) {
    const id = e.target.dataset.id;
    if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
      fetch("{% url 'photometadata:db_delete_ajax' 0 %}".replace('/0/', `/${id}/`), {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken}
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok) e.target.closest('tr').remove();
        else alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
      });
    }
  }
});

// ======= AJAX –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï =======
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('edit-btn')) {
    const id = e.target.dataset.id;
    fetch("{% url 'photometadata:db_get_ajax' 0 %}".replace('/0/', `/${id}/`))
    .then(r => r.json())
    .then(item => {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      document.getElementById('edit-id').value = item.id;
      document.getElementById('edit-title').value = item.title || '';
      document.getElementById('edit-photographer').value = item.photographer || '';
      document.getElementById('edit-date').value = item.date_taken || '';
      document.getElementById('edit-description').value = item.description || '';
      document.getElementById('edit-location').value = item.location || '';
      document.getElementById('edit-camera').value = item.camera || '';
      document.getElementById('edit-license').value = item.license || '';
      document.getElementById('edit-url').value = item.url || '';
      document.getElementById('edit-tags').value = item.tags || '';
      document.getElementById('edit-width').value = item.width || 1;
      document.getElementById('edit-height').value = item.height || 1;

      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      const saveBtn = document.getElementById('saveEditBtn');
      saveBtn.dataset.id = item.id; // –ü—Ä–∏–≤—è–∑–∞–ª–∏ ID –∫ –∫–Ω–æ–ø–∫–µ
      modal.show();
    });
  }
});

// ======= AJAX –°–û–•–†–ê–ù–ï–ù–ò–ï =======
document.getElementById('saveEditBtn').addEventListener('click', function() {
  const id = this.dataset.id;

  const data = {
    title: document.getElementById("edit-title").value.trim(),
    photographer: document.getElementById("edit-photographer").value.trim(),
    date_taken: document.getElementById("edit-date").value.trim(),
    description: document.getElementById("edit-description").value.trim(),
    location: document.getElementById("edit-location").value.trim(),
    camera: document.getElementById("edit-camera").value.trim(),
    license: document.getElementById("edit-license").value.trim(),
    tags: document.getElementById("edit-tags").value.trim(),
    url: document.getElementById("edit-url").value.trim(),
    width: parseInt(document.getElementById("edit-width").value) || 1,
    height: parseInt(document.getElementById("edit-height").value) || 1
  };

  fetch(`/ajax/update/${id}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken,
    },
    body: JSON.stringify(data),
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (row) {
        row.children[0].textContent = res.item.title;
        row.children[1].textContent = res.item.photographer;
        row.children[2].textContent = res.item.date_taken;
        row.children[3].textContent = res.item.description;
        row.children[4].textContent = res.item.location;
        row.children[5].textContent = res.item.camera;
        row.children[6].textContent = res.item.license;
        row.children[7].textContent = res.item.width;
        row.children[8].textContent = res.item.height;
        row.children[9].textContent = res.item.tags;
        const img = row.querySelector("img");
        if (img) img.src = res.item.url;
      }
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    } else {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + (res.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
    }
  })
  .catch(err => {
    console.error(err);
    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.");
  });
});
</script>


{% endif %}
{% endblock %}

